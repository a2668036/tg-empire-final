# 帝国社区Telegram机器人安装与配置指南

本指南将帮助您从头开始安装和配置帝国社区Telegram机器人系统。

## 1. 服务器准备

### 1.1 系统要求
- Ubuntu 20.04 LTS 或更高版本
- 至少1GB RAM
- 至少20GB存储空间
- 公网IP或内网穿透服务

### 1.2 安装基础软件
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y curl git nginx

# 安装Node.js (v16+)
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt install -y nodejs

# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 安装Redis
sudo apt install -y redis-server
```

## 2. 下载项目代码

```bash
# 克隆代码仓库
git clone https://github.com/您的用户名/tg-empire.git ~/tg-empire

# 进入项目目录
cd ~/tg-empire
```

## 3. 设置后端服务

### 3.1 安装依赖
```bash
cd ~/tg-empire/backend
npm install
```

### 3.2 配置环境变量
创建.env文件:
```bash
cat > .env << 'EOF'
# 应用配置
TELEGRAM_BOT_TOKEN=您的机器人Token
NODE_ENV=development
PORT=3000
API_BASE_URL=您的API地址

# 数据库配置
DATABASE_URL=postgresql://用户名:密码@localhost:5432/数据库名
REDIS_URL=redis://localhost:6379

# Telegram配置
TELEGRAM_BOT_USERNAME=您的机器人用户名
WEBHOOK_URL=您的webhook地址
EOF
```

### 3.3 初始化数据库
```bash
# 登录PostgreSQL
sudo -u postgres psql

# 在PostgreSQL控制台执行:
CREATE DATABASE tg_empire;
CREATE USER tg_admin WITH PASSWORD 'tg_password';
GRANT ALL PRIVILEGES ON DATABASE tg_empire TO tg_admin;
\q

# 导入初始数据(如果有)
# psql -U tg_admin -d tg_empire -f ~/tg-empire/scripts/init_database.sql
```

## 4. 设置内网穿透

### 4.1 安装Cpolar
```bash
curl -L https://www.cpolar.com/static/downloads/install-release-cpolar.sh | sudo bash
```

### 4.2 配置Cpolar
```bash
# 获取认证token (需要先注册Cpolar账号)
cpolar authtoken 您的认证令牌

# 配置隧道
cat > ~/.cpolar/cpolar.yml << EOF
authtoken: 您的认证令牌
tunnels:
  telegram-webhook:
    proto: http
    addr: 3000
    region: cn
    host_header: rewrite
  static-web:
    proto: http
    addr: 80
    region: cn
    host_header: rewrite
EOF

# 设置开机自启
sudo systemctl enable cpolar
sudo systemctl start cpolar
```

### 4.3 配置Nginx
```bash
# 创建Nginx配置
cat > /etc/nginx/sites-available/frontend << 'EOF'
server {
    listen 80;
    server_name localhost;

    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 配置CORS
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,x-telegram-id';
}
EOF

# 启用站点
sudo ln -sf /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# 复制前端文件
sudo mkdir -p /var/www/html
sudo cp ~/tg-empire/frontend/public/profile.html /var/www/html/index.html

# 重启Nginx
sudo systemctl restart nginx
```

## 5. 配置Telegram Bot

### 5.1 创建机器人
1. 访问 Telegram 中的 BotFather (@BotFather)
2. 发送 `/newbot` 命令
3. 按提示设置机器人名称和用户名
4. 保存返回的API令牌

### 5.2 设置Webhook
确保Cpolar服务已启动，并记下隧道URL:
```bash
# 查看隧道URL
sudo tail -n 100 /var/log/cpolar/access.log | grep -i "tunnel established"
```

设置Webhook:
```bash
# 替换YOUR_BOT_TOKEN和YOUR_WEBHOOK_URL为实际值
curl -F "url=YOUR_WEBHOOK_URL/webhook" "https://api.telegram.org/botYOUR_BOT_TOKEN/setWebhook"
```

## 6. 启动服务

### 6.1 后端服务
```bash
cd ~/tg-empire/backend
npm run dev

# 或使用PM2持久运行
npm install -g pm2
pm2 start src/server.js --name tg-empire-backend
```

## 7. 验证部署

1. 在Telegram中找到您的机器人并发送 `/start` 命令
2. 测试 `/profile` 命令，确认可以打开个人主页
3. 测试签到功能和其他功能

## 8. 维护说明

### 8.1 查看日志
```bash
# 后端日志
tail -f ~/tg-empire/logs/backend.log

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# Cpolar日志
sudo tail -f /var/log/cpolar/access.log
```

### 8.2 重启服务
```bash
# 重启后端
cd ~/tg-empire/backend
pm2 restart tg-empire-backend

# 重启Nginx
sudo systemctl restart nginx

# 重启Cpolar
sudo systemctl restart cpolar
```

### 8.3 更新代码
```bash
cd ~/tg-empire
git pull
cd backend
npm install
cd ../frontend
npm install
```
