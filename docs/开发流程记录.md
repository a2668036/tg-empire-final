# 帝国社区Telegram机器人开发流程记录

## 1. 初始环境搭建

### 1.1 后端服务搭建
- 使用Node.js和Express框架创建后端服务
- 配置PostgreSQL数据库和Redis缓存
- 设置环境变量和配置文件

### 1.2 Telegram Bot设置
- 通过BotFather创建机器人并获取API Token
- 配置机器人命令菜单（/start和/profile）
- 设置机器人Webhook回调地址

## 2. 关键功能实现

### 2.1 用户系统
- 实现用户注册和资料存储
- 创建用户服务(userService.js)处理用户相关逻辑

### 2.2 签到功能
- 实现每日签到功能
- 记录连续签到天数
- 根据签到计算声望点数

### 2.3 声望系统
- 实现声望点数的获取与消费
- 记录声望历史变动

## 3. 前端开发

### 3.1 初始方案
- 使用Vue.js框架创建前端应用
- 使用Vite作为开发服务器
- 配置前端路由和状态管理

### 3.2 遇到的挑战
- Telegram WebApp环境的特殊限制
- 跨域请求问题
- 页面加载空白问题

### 3.3 解决方案
- 改用静态HTML页面替代复杂Vue应用
- 直接在页面中集成Telegram WebApp SDK
- 使用Nginx提供静态文件服务
- 确保API请求正确传递Telegram用户ID

## 4. 内网穿透配置

### 4.1 Cpolar设置
- 安装Cpolar客户端
- 配置Telegram Bot后端服务隧道
- 配置静态页面服务隧道

### 4.2 Webhook配置
- 设置Telegram Bot的Webhook到Cpolar提供的URL
- 解决SSL证书验证问题
- 测试Webhook请求接收

## 5. 最终部署架构

```
[Telegram用户] → [Telegram Bot API] → [Cpolar隧道] → [Express后端] → [数据库]
     ↓
[Telegram WebApp] → [Cpolar静态页面隧道] → [Nginx静态服务] → [Express API]
```

## 6. 已解决的关键问题

1. **Webhook SSL证书验证失败**：通过使用Cpolar内网穿透解决
2. **WebApp页面加载空白**：简化前端架构，使用静态页面解决
3. **404页面错误**：修正Nginx配置和URL路径问题
4. **跨域请求失败**：添加正确的CORS头部和API代理

## 7. 维护与更新注意事项

1. Cpolar隧道URL会变化，需要相应更新botHandler.js中的URL配置
2. 代码更新前务必备份当前工作状态
3. 定期检查Telegram Bot API的更新和兼容性
4. 注意保护.env文件中的敏感信息
