<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è°ƒè¯•ç‰ˆæœ¬ - å¸å›½ç¤¾åŒº</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding: 20px;
    }
    
    .debug-info {
      background: #f0f0f0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    
    .error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .success {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    
    .loading {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ TG Empire è°ƒè¯•é¡µé¢</h1>
  
  <div id="status" class="debug-info loading">
    æ­£åœ¨åˆå§‹åŒ–è°ƒè¯•ç¯å¢ƒ...
  </div>
  
  <div>
    <button onclick="testBasicFunctionality()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
    <button onclick="testTelegramSDK()">æµ‹è¯•Telegram SDK</button>
    <button onclick="testAPIConnection()">æµ‹è¯•APIè¿æ¥</button>
    <button onclick="testVueComponents()">æµ‹è¯•Vueç»„ä»¶</button>
  </div>
  
  <div id="results"></div>
  
  <div id="vue-app">
    <!-- Vueåº”ç”¨å°†åœ¨è¿™é‡ŒæŒ‚è½½ -->
  </div>

  <script type="module">
    // å…¨å±€é”™è¯¯æ•è·
    window.addEventListener('error', (event) => {
      addResult(`âŒ JavaScripté”™è¯¯: ${event.error.message}`, 'error');
      console.error('JavaScripté”™è¯¯:', event.error);
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      addResult(`âŒ Promiseé”™è¯¯: ${event.reason}`, 'error');
      console.error('Promiseé”™è¯¯:', event.reason);
    });
    
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    
    function updateStatus(message, type = 'loading') {
      statusDiv.className = `debug-info ${type}`;
      statusDiv.textContent = message;
    }
    
    function addResult(message, type = 'debug-info') {
      const div = document.createElement('div');
      div.className = `debug-info ${type}`;
      div.innerHTML = message;
      resultsDiv.appendChild(div);
    }
    
    // æµ‹è¯•åŸºç¡€åŠŸèƒ½
    window.testBasicFunctionality = function() {
      addResult('ğŸ” æµ‹è¯•åŸºç¡€åŠŸèƒ½...');
      
      // æµ‹è¯•DOMæ“ä½œ
      try {
        const testDiv = document.createElement('div');
        testDiv.textContent = 'DOMæ“ä½œæµ‹è¯•';
        addResult('âœ… DOMæ“ä½œæ­£å¸¸', 'success');
      } catch (error) {
        addResult(`âŒ DOMæ“ä½œå¤±è´¥: ${error.message}`, 'error');
      }
      
      // æµ‹è¯•ES6æ¨¡å—
      try {
        const testPromise = new Promise(resolve => resolve('ES6æµ‹è¯•'));
        testPromise.then(() => {
          addResult('âœ… ES6 Promiseæ­£å¸¸', 'success');
        });
      } catch (error) {
        addResult(`âŒ ES6åŠŸèƒ½å¤±è´¥: ${error.message}`, 'error');
      }
      
      // æµ‹è¯•Fetch API
      if (typeof fetch !== 'undefined') {
        addResult('âœ… Fetch APIå¯ç”¨', 'success');
      } else {
        addResult('âŒ Fetch APIä¸å¯ç”¨', 'error');
      }
    };
    
    // æµ‹è¯•Telegram SDK
    window.testTelegramSDK = function() {
      addResult('ğŸ“± æµ‹è¯•Telegram SDK...');
      
      try {
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
          addResult('âœ… Telegram WebApp SDKå·²åŠ è½½', 'success');
          addResult(`ğŸ“± å¹³å°: ${Telegram.WebApp.platform}`);
          addResult(`ğŸ¨ ç‰ˆæœ¬: ${Telegram.WebApp.version}`);
          
          // åˆå§‹åŒ–WebApp
          Telegram.WebApp.ready();
          addResult('âœ… WebApp.ready() è°ƒç”¨æˆåŠŸ', 'success');
          
          // æ£€æŸ¥ç”¨æˆ·æ•°æ®
          if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
            const user = Telegram.WebApp.initDataUnsafe.user;
            addResult(`ğŸ‘¤ ç”¨æˆ·: ${user.first_name} ${user.last_name} (@${user.username})`, 'success');
          } else {
            addResult('âš ï¸ æœªæ£€æµ‹åˆ°ç”¨æˆ·æ•°æ®ï¼ˆå¼€å‘ç¯å¢ƒæ­£å¸¸ï¼‰');
          }
          
          // è®¾ç½®ä¸»é¢˜
          Telegram.WebApp.setHeaderColor('#007bff');
          addResult('âœ… ä¸»é¢˜è®¾ç½®æˆåŠŸ', 'success');
          
        } else {
          addResult('âŒ Telegram WebApp SDKæœªåŠ è½½', 'error');
        }
      } catch (error) {
        addResult(`âŒ Telegram SDKé”™è¯¯: ${error.message}`, 'error');
      }
    };
    
    // æµ‹è¯•APIè¿æ¥
    window.testAPIConnection = async function() {
      addResult('ğŸŒ æµ‹è¯•APIè¿æ¥...');
      
      try {
        // æµ‹è¯•å¥åº·æ£€æŸ¥
        const healthResponse = await fetch('/health');
        if (healthResponse.ok) {
          const data = await healthResponse.json();
          addResult('âœ… APIå¥åº·æ£€æŸ¥æˆåŠŸ', 'success');
          addResult(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
        } else {
          addResult(`âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥: ${healthResponse.status}`, 'error');
        }
        
        // æµ‹è¯•ç”¨æˆ·APIï¼ˆä½¿ç”¨æµ‹è¯•ç”¨æˆ·IDï¼‰
        const userResponse = await fetch('/api/v1/users/me', {
          headers: {
            'x-telegram-id': '999888777'
          }
        });
        
        if (userResponse.ok) {
          const userData = await userResponse.json();
          addResult('âœ… ç”¨æˆ·APIè°ƒç”¨æˆåŠŸ', 'success');
          addResult(`<pre>${JSON.stringify(userData, null, 2)}</pre>`);
        } else if (userResponse.status === 404) {
          addResult('âš ï¸ ç”¨æˆ·ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼Œéœ€è¦æ³¨å†Œï¼‰');
        } else {
          addResult(`âŒ ç”¨æˆ·APIè°ƒç”¨å¤±è´¥: ${userResponse.status}`, 'error');
        }
        
      } catch (error) {
        addResult(`âŒ APIè¿æ¥é”™è¯¯: ${error.message}`, 'error');
      }
    };
    
    // æµ‹è¯•Vueç»„ä»¶
    window.testVueComponents = async function() {
      addResult('âš¡ æµ‹è¯•Vueç»„ä»¶...');
      
      try {
        // åŠ¨æ€å¯¼å…¥Vueï¼ˆä½¿ç”¨CDNï¼‰
        if (!window.Vue) {
          // å¦‚æœVueæœªåŠ è½½ï¼ŒåŠ¨æ€åŠ è½½Vue CDN
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/vue@3/dist/vue.global.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        const { createApp } = Vue;
        addResult('âœ… Vue 3å¯¼å…¥æˆåŠŸ', 'success');
        
        // åˆ›å»ºç®€å•çš„Vueåº”ç”¨
        const app = createApp({
          data() {
            return {
              message: 'Vueåº”ç”¨è¿è¡Œæ­£å¸¸ï¼',
              count: 0
            }
          },
          template: `
            <div style="padding: 20px; background: #e3f2fd; border-radius: 8px; margin: 10px 0;">
              <h3>{{ message }}</h3>
              <p>è®¡æ•°å™¨: {{ count }}</p>
              <button @click="count++" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                ç‚¹å‡» +1
              </button>
            </div>
          `
        });
        
        app.mount('#vue-app');
        addResult('âœ… Vueåº”ç”¨æŒ‚è½½æˆåŠŸ', 'success');
        
      } catch (error) {
        addResult(`âŒ Vueç»„ä»¶æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        console.error('Vueé”™è¯¯è¯¦æƒ…:', error);
      }
    };
    
    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
    document.addEventListener('DOMContentLoaded', () => {
      updateStatus('è°ƒè¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ', 'success');
      
      // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
      setTimeout(() => {
        testBasicFunctionality();
        testTelegramSDK();
      }, 500);
    });
  </script>
</body>
</html>
