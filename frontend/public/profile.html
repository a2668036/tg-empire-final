<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>帝国社区 - 个人主页</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
    }
    
    #app {
      height: 100vh;
      width: 100%;
      overflow-x: hidden;
      padding: 16px;
    }

    .profile-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .stats-container {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--tg-theme-button-color, #2481cc);
    }

    .stat-label {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999999);
      margin-top: 4px;
    }

    .action-button {
      background-color: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 0;
    }

    .action-button.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: var(--tg-theme-hint-color, #999999);
    }

    .error {
      color: #e74c3c;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="loading" class="loading">
      加载中...
    </div>
    <div v-else-if="error" class="error">
      {{ error }}
    </div>
    <div v-else class="profile-container">
      <div class="profile-header">
        <h1>{{ user.first_name }} {{ user.last_name }}</h1>
        <div class="username">@{{ user.username }}</div>
      </div>
      
      <div class="stats-container">
        <div class="stat-item">
          <div class="stat-value">{{ user.reputation_points }}</div>
          <div class="stat-label">声望</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ user.empire_stars }}</div>
          <div class="stat-label">帝国之星</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ user.consecutive_check_ins }}</div>
          <div class="stat-label">连续签到</div>
        </div>
      </div>
      
      <div class="action-button" @click="checkIn" :class="{ disabled: checkedInToday }">
        {{ checkedInToday ? '今日已签到' : '每日签到' }}
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp SDK
    const webAppSdk = {
      get instance() {
        return window.Telegram.WebApp;
      },
      
      getInitData() {
        try {
          if (!window.Telegram.WebApp.initData) {
            console.warn('WebApp initData为空');
            return null;
          }
          
          return window.Telegram.WebApp.initDataUnsafe || null;
        } catch (error) {
          console.error('获取initData失败:', error);
          return null;
        }
      },
      
      showAlert(message) {
        window.Telegram.WebApp.showAlert(message);
      }
    };

    // 初始化WebApp
    function initWebApp() {
      try {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.setHeaderColor('secondary_bg_color');
        console.log('Telegram WebApp初始化成功');
      } catch (error) {
        console.error('Telegram WebApp初始化失败:', error);
      }
    }

    // 调用初始化
    initWebApp();

    // API服务
    const api = axios.create({
      baseURL: 'https://338a537.r3.cpolar.cn/api/v1',
      timeout: 10000,
      headers: {
        'Content-Type': 'application/json'
      }
    });

    // 添加请求拦截器
    api.interceptors.request.use(config => {
      const telegramInitData = webAppSdk.getInitData();
      
      if (telegramInitData && telegramInitData.user) {
        config.headers['x-telegram-id'] = telegramInitData.user.id;
      } else {
        // 调试用，可以移除
        config.headers['x-telegram-id'] = '123456789';
      }
      
      return config;
    });

    // Vue应用
    Vue.createApp({
      data() {
        return {
          user: {
            first_name: '',
            last_name: '',
            username: '',
            reputation_points: 0,
            empire_stars: 0,
            consecutive_check_ins: 0,
            last_check_in_date: null
          },
          loading: true,
          error: null,
          checkedInToday: false
        }
      },
      
      mounted() {
        this.loadUserData();
      },
      
      methods: {
        async loadUserData() {
          try {
            const response = await api.get('/users/me');
            this.user = response.data;
            
            // 检查今日是否已签到
            const today = new Date().toISOString().split('T')[0];
            this.checkedInToday = this.user.last_check_in_date && 
                                 this.user.last_check_in_date.startsWith(today);
            
            this.loading = false;
          } catch (error) {
            console.error('获取用户数据失败:', error);
            this.error = '获取用户数据失败，请重试';
            this.loading = false;
          }
        },
        
        async checkIn() {
          if (this.checkedInToday) return;
          
          try {
            const response = await api.post('/users/check-in');
            webAppSdk.showAlert(`签到成功！获得 ${response.data.points_earned} 点声望`);
            
            // 更新用户数据
            this.loadUserData();
          } catch (error) {
            console.error('签到失败:', error);
            webAppSdk.showAlert('签到失败，请重试');
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
 